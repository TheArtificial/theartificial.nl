---
title: Search
---
<% content_for :javascript_tags do %>
	<%= javascript_include_tag 'lunr' %>
<% end %>

<section id="content">

	<div class="bleed">
		<div class="flex container">
			<div class="col-10 left-1 right-1 section-title">
				<div class="padded center">
					<h1 class="title">Search</h1>
				</div>
				<div class="padded center" id="results">

				</div>
			</div>
		</div>
	</div>

</section>

<script>
  // parse querystring value
  function paramValue(query_param) {
    var results = new RegExp('[\\?&]' + query_param + '=([^&#]*)').exec(window.location.href);
    return results ? results[1] : false;
  }

  var monthNames = new Array("January","February","March","April","May"," June","July","August","September","October","November","December");
  function monthName(n) {
    return(monthNames[n]);
  }

  var lunrIndex;
  var lunrMap;

  function lunrSearch(el) {
    var query = paramValue('query');

    $('.title').html('Pages containing “' + query + '”');

    console.log('Requesting Lunr file');
    el.append('loading');

    $.ajax({
      dataType: "json",
      url: '/search/index.json',
      xhr: function() {
        var xhr = new window.XMLHttpRequest();
        //Download progress
        xhr.addEventListener("progress", function(evt){
          el.append('.');
        }, false);
        return xhr;
      },
      success: function(data) {

        lunrIndex = lunr.Index.load(data.index);
        lunrMap = data.docs;
        var results = lunrIndex.search(query)
        console.log('Found ' + results.length + ' results');

        var list = $('<ol class="article-list">');
        $.each(results, function(index, result) {
          page = lunrMap[result.ref];

          var type = page.type;
          var where = 'unknown';

          if (type == 'blog') {
            date = new Date(page.date);
            // where = monthName(date.getMonth()) + ' ' + ordinal(date.getDate()) + ', ' + date.getFullYear();
          }

          list.append('<li>' +
              '<a href="' + page.url + '">' +
                '<span>' + page.title + '<\/span>' +
              '<\/a>' +
              ' (' + page.author + ')' +
            '<\/li>');
        });
        list.append('<\/ol>');
        if (results.length > 0) {
          el.html(''); // clear loading indicator
          el.append(list);
        }
        else {
          el.html('No results, sorry.');
        }
      }
    });
  }

  $(document).ready(function() {
    lunrSearch($('#results'));
  });

</script>
