// searching

var lunrIndex;
var lunrMap;

var $placeholderCard = $("<%=escape_javascript( mustache_template('search/_placeholder_card.html') ) %>");

function lunrSearch(query, $el) {

  console.log('Requesting Lunr file');
  $el.html('Loading...');
  $el.packery();

  $.ajax({
    dataType: "json",
    url: '/search/index.json',
    xhr: function() {
      var xhr = new window.XMLHttpRequest();
      //Download progress
      xhr.addEventListener("progress", function(evt){
        $el.append('.');
      }, false);
      return xhr;
    },
    success: function(data) {

      lunrIndex = lunr.Index.load(data.index);
      lunrMap = data.docs;
      var results = lunrIndex.search(query)
      console.log('Found ' + results.length + ' results', results);

      if (results.length > 0) {
        $el.html(''); // clear loading indicator
        $.each(results, function(index, result) {
          page = lunrMap[result.ref];
        setTimeout(addCard($el, page),100);
        });
      }
      else {
        $el.html('No results, sorry.');
      }
    }
  });
}

// displaying
// returns a jQuery element for a given lunr.js-style document object
function renderCard(doc) {
  var type = doc.type;

  template = "<%=escape_javascript( mustache_template('search/_unknown_card.mustache') ) %>";

  var view = {
    url: doc.url,
    title: doc.title
  };
  var post_date = new Date(doc.date)
  var formatted_date = monthName(post_date.getMonth()) + ' ' + post_date.getDate() + ', ' + post_date.getFullYear();
  view.date = formatted_date;

  if (type == 'article') {
    view.author = doc.author;
    if (doc.image) {
      template = "<%=escape_javascript( mustache_template('search/_article_card_image.mustache') ) %>";
      view.image = doc.image;
    } else {
      template = "<%=escape_javascript( mustache_template('search/_article_card.mustache') ) %>";
    }
    view.category = doc.category;
    view.summary = doc.summary;
  } else if (type == 'cocktail') {
    view.author = doc.author;
    view.glass = doc.glass;
    view.contents = doc.contents;
    template = "<%=escape_javascript( mustache_template('search/_cocktail_card.mustache') ) %>";
  } else if (type == 'work') {
    view.color = doc.color;
    view.thumbnail = doc.thumbnail;
    template = "<%=escape_javascript( mustache_template('search/_work_card.mustache') ) %>";
  } else if (type == 'ftfy') {
    view.author = doc.author;
    view.image = doc.image;
    template = "<%=escape_javascript( mustache_template('search/_ftfy_card.mustache') ) %>";
  } else {
    template = "<%=escape_javascript( mustache_template('search/_unknown_card.mustache') ) %>";
  }
  return $(Mustache.render(template, view));
}

// add a card to a container
function addCard($container, doc) {
  var $newCard = $placeholderCard.clone();
  var $newCard = renderCard(doc);

  $container.append($newCard)
    // add and layout newly appended items
    .packery('appended', $newCard)
    .packery('layout');
  // re-layout on image load
  $newCard.imagesLoaded().done( function( instance, image ) {
    console.log("Image loaded", instance)
    $container.packery('layout');
  });
  $container.packery();
  console.log("Started card", doc.url);

  // render card async
  setTimeout(function(){
    console.log("Rendered card", doc.url);
    $newCard = renderCard(doc);
  }, 1);
}

var monthNames = new Array("January","February","March","April","May"," June","July","August","September","October","November","December");
function monthName(n) {
  return(monthNames[n]);
}
